<div class="page-container">
  <h2>Demandes de consentement de médecins pour l'accès à mon dossier</h2>

  <mat-progress-bar *ngIf="isLoading" mode="indeterminate" style="margin-bottom: 10px;"></mat-progress-bar>

  <div class="toolbar">

    <!-- Filtre statut -->
    <mat-button-toggle-group
      name="status"
      [value]="statusFilter"
      (change)="setStatusFilter($event.value)">
      <mat-button-toggle value="ALL">Tous</mat-button-toggle>
      <mat-button-toggle value="EN_ATTENTE">En attente</mat-button-toggle>
      <mat-button-toggle value="ACCEPTER">Acceptées</mat-button-toggle>
      <mat-button-toggle value="REFUSER">Refusées</mat-button-toggle>
    </mat-button-toggle-group>

    <!-- Recherche -->
    <mat-form-field appearance="outline" class="search">
      <mat-label>Rechercher…</mat-label>
      <input matInput [formControl]="textFilter" placeholder="Nom, prénom ou INAMI">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

  </div>

  <table mat-table [dataSource]="demandes" class="mat-elevation-z8">

    <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>#</th>
        <td mat-cell *matCellDef="let a; let i = index">
            {{ i + 1 + (paginator.pageIndex * paginator.pageSize) }}
        </td>
    </ng-container>

    <ng-container matColumnDef="medecin">
      <th mat-header-cell *matHeaderCellDef>Médecin</th>
       <td mat-cell *matCellDef="let d">
            <a class="user-link"
                (click)="goToUser(d.medecin.id, RoleUtilisateur.MEDECIN)">
                {{ d.medecin.prenom }} {{d.medecin.nom }}
            </a>
        </td>
    </ng-container>

    <ng-container matColumnDef="inami">
      <th mat-header-cell *matHeaderCellDef>INAMI</th>
      <td mat-cell *matCellDef="let d">{{ d.medecin.numINAMI }}</td>
    </ng-container>

    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef>Date</th>
      <td mat-cell *matCellDef="let d">{{ d.date | date:'dd/MM/yyyy' }}</td>
    </ng-container>

    <ng-container matColumnDef="statut">
      <th mat-header-cell *matHeaderCellDef>Statut</th>
      <td mat-cell *matCellDef="let d">
        <span [ngClass]="{
          'accepted': d.statut === 'ACCEPTER',
          'refused': d.statut === 'REFUSER',
          'pending': d.statut === 'EN_ATTENTE'
        }">{{ getLabel(d.statut) }}</span>
      </td>
    </ng-container>

    <ng-container matColumnDef="action">
      <th mat-header-cell *matHeaderCellDef>Action</th>
      <td mat-cell *matCellDef="let d">
        <button mat-button color="primary" *ngIf="canAccept(d)" 
                (click)="updateRequest(d.id!, 'ACCEPTER')">Accepter</button>
        <button mat-button color="warn" *ngIf="canRefuse(d)" 
                (click)="updateRequest(d.id!, 'REFUSER')">Refuser</button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
  </table>

  <mat-paginator [pageSizeOptions]="[5,10,20]" showFirstLastButtons></mat-paginator>
</div>
