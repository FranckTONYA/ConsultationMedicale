<mat-progress-bar *ngIf="isLoading" mode="indeterminate" style="margin-top: 20px;"></mat-progress-bar>

<div class="page-wrapper" *ngIf="form">

  <h2 class="title">Modifier dossier Médical — {{ dossier.patient.prenom }} {{ dossier.patient.nom }} </h2>

  <form [formGroup]="form">

    <!-- Groupe sanguin -->
    <!-- <div class="section">
      <div class="section-title">Groupe sanguin</div>
      <mat-form-field appearance="outline">
        <mat-label>Groupe sanguin</mat-label>
        <input matInput formControlName="groupeSanguin">
      </mat-form-field>
      <div class="field-row">
        <span class="field-label">NISS :</span>
        <span class="field-value">{{ dossier.patient.niss }}</span>
      </div>
    </div> -->
      
    <div class="info-grid">
      <div class="section-title">Infos de base</div>
      <div class="field-row">
        <span class="field-label">NISS :</span>
        <span class="field-value">{{ dossier.patient.niss }}</span>
      </div>

      <!-- Groupe sanguin -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Groupe sanguin</mat-label>
        <mat-select formControlName="groupeSanguin">
          <mat-option *ngFor="let g of groupesSanguins" [value]="g">{{ g }}</mat-option>
        </mat-select>

        <!-- Message d’erreur -->
        <!-- <mat-error *ngIf="form.get('groupeSanguin')?.hasError('required') && form.get('groupeSanguin')?.touched">
          Le groupe sanguin est obligatoire.
        </mat-error> -->
      </mat-form-field>
    </div>

    <!-- Allergies -->
    <div class="section">
      <div class="section-title">Allergies</div>
      <div formArrayName="allergies">
        <div *ngFor="let a of allergies.controls; let i = index" class="dynamic-row">
          <mat-form-field appearance="outline" class="flex-grow">
            <input matInput [formControlName]="i">
          </mat-form-field>
          <button mat-icon-button color="warn" (click)="removeItem(allergies, i)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
        <div class="add-row-btn" (click)="addItem(allergies)">+ Ajouter une allergie</div>
      </div>
    </div>

    <!-- Vaccinations -->
    <div class="section">
      <div class="section-title">Vaccinations</div>
      <div formArrayName="vaccinations">
        <div *ngFor="let v of vaccinations.controls; let i = index" class="dynamic-row">
          <mat-form-field appearance="outline" class="flex-grow">
            <input matInput [formControlName]="i">
          </mat-form-field>
          <button mat-icon-button color="warn" (click)="removeItem(vaccinations, i)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
        <div class="add-row-btn" (click)="addItem(vaccinations)">+ Ajouter une vaccination</div>
      </div>
    </div>

    <!-- Antécédents -->
    <div class="section">
      <div class="section-title">Antécédents médicaux</div>
      <div formArrayName="antecedentsMedicaux">
        <div *ngFor="let m of antecedentsMedicaux.controls; let i = index" class="dynamic-row">
          <mat-form-field appearance="outline" class="flex-grow">
            <input matInput [formControlName]="i">
          </mat-form-field>
          <button mat-icon-button color="warn" (click)="removeItem(antecedentsMedicaux, i)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
        <div class="add-row-btn" (click)="addItem(antecedentsMedicaux)">+ Ajouter un antécédent</div>
      </div>
    </div>

    <!-- Remarques -->
    <div class="section">
      <div class="section-title">Remarques</div>
      <div formArrayName="remarques">
        <div *ngFor="let r of remarques.controls; let i = index" class="dynamic-row">
          <mat-form-field appearance="outline" class="flex-grow">
            <textarea matInput [formControlName]="i"></textarea>
          </mat-form-field>
          <button mat-icon-button color="warn" (click)="removeItem(remarques, i)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
        <div class="add-row-btn" (click)="addItem(remarques)">+ Ajouter une remarque</div>
      </div>
    </div>

    
    <!-- ---------------- DOCUMENTS ---------------- -->
    <div class="section documents-section">
      <h3>Documents</h3>

      <!-- Upload -->
      <input type="file" (change)="onFileSelected($event)" multiple class="w-full mb-2">
      <div class="preview-container mb-2" *ngIf="selectedFiles.length">
        <div *ngFor="let f of selectedFiles; let i=index" class="preview-item">
          <span>{{ f.name }}</span>
          <button type="button" (click)="removeSelectedFile(i)" mat-icon-button color="warn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <hr>

      <!-- Documents existants -->
      <div class="existing-docs mt-2">
        <div *ngFor="let doc of existingDocs" class="doc-item flex justify-between items-center mb-1">
          <!-- lien pour ouvrir le document dans une nouvelle fenêtre -->
          <a href="javascript:void(0)" (click)="viewDocument(doc)" class="doc-link">{{ doc.nom }}</a>
          <button mat-icon-button color="warn" (click)="deleteDoc(doc.id)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
       </div>

    </div>
    <!-- ---------------- FIN DOCUMENTS ---------------- -->

    <div class="action-buttons">
      <button mat-stroked-button color="primary" (click)="cancel()" style="color: white;  background-color: #ea3535;">Annuler</button>
      <button mat-raised-button color="accent" (click)="save()" style="color: white;  background-color: green;">Sauvegarder</button>
    </div>
  </form>

</div>
